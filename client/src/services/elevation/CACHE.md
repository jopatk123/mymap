# 高程服务缓存策略说明

## 缓存层级

高程数据使用三层缓存策略，从浏览器到应用层全方位优化性能：

### 第一层：浏览器 HTTP 缓存 ✅
**位置**: 浏览器磁盘缓存
**时长**: 1 年（31536000 秒）
**配置**: `server/src/app.js`

```javascript
Cache-Control: public, max-age=31536000, immutable
```

**作用**:
- ✅ GeoTIFF 文件首次加载后永久缓存（1年内不过期）
- ✅ 刷新页面时无需重新下载
- ✅ 关闭浏览器重新打开也能使用缓存
- ✅ 大幅减少网络流量

### 第二层：瓦片内存缓存 ✅
**位置**: `client/src/services/elevation/tile-loader.js`
**时长**: 页面会话期间
**实现**: Map 对象

```javascript
const tileCache = new Map(); // tileId -> { meta, image }
```

**作用**:
- ✅ 避免重复解析同一个 GeoTIFF 文件
- ✅ 快速响应高程查询
- ✅ 减少 CPU 消耗

### 第三层：等高线特征缓存 ✅
**位置**: `client/src/services/elevation/elevation-service.js`
**时长**: 页面会话期间
**实现**: Map 对象

```javascript
const contourCache = new Map(); // tileId -> GeoJSON features
```

**作用**:
- ✅ 避免重复计算等高线（计算密集型）
- ✅ 地图平移时快速显示已计算的等高线
- ✅ 提升用户体验

## 缓存效果对比

| 操作 | 首次访问 | 刷新页面 | 关闭重开 | 平移地图 |
|------|---------|---------|---------|---------|
| 网络请求 | ✅ 需要 | ❌ 无需 | ❌ 无需 | ❌ 无需 |
| GeoTIFF 解析 | ✅ 需要 | ✅ 需要 | ✅ 需要 | ❌ 无需 |
| 等高线计算 | ✅ 需要 | ✅ 需要 | ✅ 需要 | ❌ 无需* |

*注：平移到新区域时需要计算，但已访问区域直接使用缓存

## 性能提升数据

### 网络加载
- **首次加载**: ~69 MB × 6 个文件 = ~414 MB（按需加载，实际可能少于此）
- **后续访问**: 0 MB（浏览器缓存）
- **节省流量**: 接近 100%

### 响应时间
- **高程查询**（单点）: 
  - 首次: ~100-200ms（含网络+解析）
  - 缓存: ~1-5ms（纯计算）
  - **提升**: 20-200倍
  
- **等高线生成**:
  - 首次: ~500-1000ms（含网络+解析+计算）
  - 缓存: ~10-50ms（纯渲染）
  - **提升**: 10-100倍

## 清除缓存方法

### 清除应用层缓存（内存）
在浏览器控制台执行：

```javascript
// 方法1: 通过服务对象
import { elevationService } from '@/services/elevation';
elevationService.clearCaches();

// 方法2: 刷新页面（自动清除）
location.reload();
```

### 清除浏览器缓存
1. 打开开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

或：

1. 打开浏览器设置
2. 搜索"清除浏览器数据"
3. 选择"缓存的图片和文件"
4. 点击"清除数据"

## 何时需要清除缓存？

### ✅ 需要清除的情况
1. **GeoTIFF 文件已更新**
   - 更新了地形数据
   - 修改了文件内容
   
2. **发现数据错误**
   - 高程值不准确
   - 等高线位置偏移

3. **开发调试**
   - 测试新的缓存策略
   - 验证数据加载流程

### ❌ 无需清除的情况
1. **正常使用**：缓存是为了提升性能，无需手动清除
2. **切换地图位置**：应用会自动加载新区域的数据
3. **长时间未访问**：浏览器会自动管理缓存空间

## 优化建议

### 对于开发者
1. **不要修改现有 GeoTIFF 文件**
   - 如需更新，使用新文件名
   - 或添加版本号（如 `srtm_60_07_v2.tif`）
   
2. **监控缓存大小**
   - 每个 GeoTIFF 约 69MB
   - 6个文件总计 ~414MB
   - 浏览器通常限制每个域 50MB-1GB

3. **考虑分块策略**
   - 如果数据更大，考虑更细粒度的切片
   - 按需加载更小的区块

### 对于用户
1. **首次访问较慢是正常的**
   - 需要下载 GeoTIFF 文件
   - 建议在 WiFi 环境下首次访问
   
2. **保持浏览器缓存**
   - 不要频繁清除浏览器数据
   - 缓存能显著提升加载速度

## 技术细节

### HTTP Range 请求
GeoTIFF 加载使用 HTTP Range 请求，支持：
- ✅ 只读取需要的数据块（不是整个文件）
- ✅ 并行加载多个数据块
- ✅ 断点续传

服务器配置：
```javascript
res.set('Accept-Ranges', 'bytes');
res.set('Access-Control-Expose-Headers', 'Content-Range, Accept-Ranges');
```

### 缓存验证
浏览器缓存使用 `immutable` 指令：
- 告诉浏览器文件永远不会改变
- 跳过 ETag/Last-Modified 验证
- 直接使用缓存，不发送验证请求

### 内存管理
应用层缓存使用 JavaScript Map：
- 自动垃圾回收
- 不会无限增长（页面关闭时清空）
- 不影响浏览器性能

## 常见问题

### Q: 缓存会占用多少磁盘空间？
A: 最多约 414MB（6个文件 × 69MB），但实际可能更少，因为：
1. 只加载用户访问过的区域
2. 浏览器会自动管理缓存空间
3. 使用 Range 请求可能只缓存部分数据

### Q: 缓存过期后会怎样？
A: 1年后浏览器会重新验证缓存，由于设置了 `immutable`，通常会继续使用缓存。如果服务器返回 304 Not Modified，则继续使用；否则重新下载。

### Q: 不同浏览器的缓存是否共享？
A: 不共享。每个浏览器维护独立的缓存。如果用户使用 Chrome 和 Firefox，两个浏览器都需要独立下载和缓存。

### Q: 隐私模式下缓存如何工作？
A: 隐私/无痕模式下，缓存仅在当前会话有效，关闭窗口后自动清除。建议在正常模式下使用以获得最佳性能。

### Q: 移动设备上的缓存策略？
A: 相同策略，但建议：
1. 首次访问使用 WiFi
2. 注意存储空间限制
3. 某些浏览器可能更激进地清理缓存

## 监控和调试

### 查看缓存状态
在浏览器开发者工具中：

1. **Network 标签页**
   - 查看请求状态码
   - `200` = 从服务器加载
   - `304` = 缓存验证通过
   - `(disk cache)` = 从浏览器缓存读取

2. **Application 标签页**
   - Cache Storage 查看缓存内容
   - 查看缓存大小和文件列表

3. **Console 控制台**
   - 查看 `[TileLoader]` 日志
   - 确认缓存命中情况

### 性能分析
```javascript
// 在控制台执行，查看缓存命中率
performance.getEntriesByType('resource')
  .filter(r => r.name.includes('/geo/'))
  .forEach(r => console.log({
    url: r.name,
    duration: r.duration,
    transferSize: r.transferSize,
    fromCache: r.transferSize === 0
  }));
```
