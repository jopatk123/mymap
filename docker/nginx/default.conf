upstream mymap_upstream {
  server mymap:3002;
}

server {
  listen 50000;
  listen [::]:50000;

  # 最低限度的代理头部，保留真实 IP
  server_name _;

   # 允许较大文件上传（配合后端 MAX_FILE_SIZE）
   client_max_body_size 50m;
   proxy_read_timeout 300s;
   proxy_send_timeout 300s;

  # 前端与 API 均由 Node 服务静态/动态提供
  location / {
    proxy_pass http://mymap_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 避免缓存 index.html
    if ($request_uri ~* "index\\.html$") {
      add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }
  }

  # 静态资源可缓存（由 Node 提供，但这里加一层缓存头）
  location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf)$ {
    proxy_pass http://mymap_upstream;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # 上传目录直通（可选：也直接代理到 Node）
  location /uploads/ {
    proxy_pass http://mymap_upstream;
  }

  # 健康检查（传给后端）
  location /api/health {
    proxy_pass http://mymap_upstream;
  }
}


