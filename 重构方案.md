
# 地图全景系统重构方案

## 1. 项目概述

### 1.1 当前架构分析
- **后端**: Node.js + Express + MySQL
- **前端**: Vue 3 + Vite + Element Plus
- **数据存储**: 
  - 全景图数据（panoramas表）
  - 视频点位数据（video_points表）
  - KML文件数据（kml_files表 + kml_points表）
  - 样式配置数据（多个样式配置表）

### 1.2 重构目标
1. **配置文件化**: 将数据库中的配置数据迁移到JSON文件
2. **数据库简化**: 整理和统一数据库脚本，移除配置相关表
3. **架构优化**: 改善配置管理机制，提高性能和可维护性

## 2. 详细重构计划

### 2.1 第一阶段：配置文件重构

#### 2.1.1 创建配置文件结构
**新建文件**: `/server/config/app-config.json`

```json
{
  "version": "1.0.0",
  "pointStyles": {
    "panorama": {
      "point_color": "#2ed573",
      "point_size": 8,
      "point_opacity": 1.0,
      "point_icon_type": "circle",
      "point_label_size": 12,
      "point_label_color": "#000000"
    },
    "video": {
      "point_color": "#ff4757",
      "point_size": 10,
      "point_opacity": 1.0,
      "point_icon_type": "marker",
      "point_label_size": 14,
      "point_label_color": "#000000"
    }
  },
  "kmlStyles": {
    "default": {
      "point_color": "#ff7800",
      "point_size": 8,
      "point_opacity": 1.0,
      "point_icon_type": "marker",
      "point_label_size": 12,
      "point_label_color": "#000000",
      "line_color": "#ff7800",
      "line_width": 2,
      "line_opacity": 0.8,
      "line_style": "solid",
      "polygon_fill_color": "#ff7800",
      "polygon_fill_opacity": 0.3,
      "polygon_stroke_color": "#ff7800",
      "polygon_stroke_width": 2,
      "polygon_stroke_style": "solid",
      "cluster_enabled": true,
      "cluster_icon_color": "#ffffff",
      "cluster_text_color": "#000000"
    }
  },
  "mapSettings": {
    "defaultCenter": [116.4074, 39.9042],
    "defaultZoom": 12,
    "minZoom": 3,
    "maxZoom": 18,
    "mapType": "normal"
  },
  "uploadSettings": {
    "maxFileSize": 104857600,
    "allowedImageTypes": ["jpg", "jpeg", "png"],
    "allowedVideoTypes": ["mp4", "avi", "mov"],
    "allowedKmlTypes": ["kml", "kmz"],
    "thumbnailSize": {
      "width": 300,
      "height": 200
    }
  }
}
```

#### 2.1.2 创建配置管理服务
**新建文件**: `/server/src/services/ConfigService.js`

```javascript
const fs = require('fs').promises
const path = require('path')

class ConfigService {
  constructor() {
    this.configPath = path.join(__dirname, '../../config/app-config.json')
    this.config = null
    this.lastModified = null
  }

  async loadConfig() {
    try {
      const stats = await fs.stat(this.configPath)
      if (!this.config || stats.mtime > this.lastModified) {
        const data = await fs.readFile(this.configPath, 'utf8')
        this.config = JSON.parse(data)
        this.lastModified = stats.mtime
      }
      return this.config
    } catch (error) {
      console.error('加载配置文件失败:', error)
      return this.getDefaultConfig()
    }
  }

  async saveConfig(newConfig) {
    try {
      await fs.writeFile(this.configPath, JSON.stringify(newConfig, null, 2))
      this.config = newConfig
      this.lastModified = new Date()
      return true
    } catch (error) {
      console.error('保存配置文件失败:', error)
      return false
    }
  }

  async getPointStyles(type) {
    const config = await this.loadConfig()
    return config.pointStyles[type] || config.pointStyles.panorama
  }

  async updatePointStyles(type, styles) {
    const config = await this.loadConfig()
    config.pointStyles[type] = { ...config.pointStyles[type], ...styles }
    return await this.saveConfig(config)
  }

  async getKmlStyles(fileId = 'default') {
    const config = await this.loadConfig()
    return config.kmlStyles[fileId] || config.kmlStyles.default
  }

  async updateKmlStyles(fileId, styles) {
    const config = await this.loadConfig()
    config.kmlStyles[fileId] = { ...config.kmlStyles[fileId] || config.kmlStyles.default, ...styles }
    return await this.saveConfig(config)
  }

  getDefaultConfig() {
    // 返回硬编码的默认配置
    return {
      version: "1.0.0",
      pointStyles: {
        panorama: {
          point_color: "#2ed573",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "circle",
          point_label_size: 12,
          point_label_color: "#000000"
        },
        video: {
          point_color: "#ff4757",
          point_size: 10,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 14,
          point_label_color: "#000000"
        }
      },
      kmlStyles: {
        default: {
          point_color: "#ff7800",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 12,
          point_label_color: "#000000",
          line_color: "#ff7800",
          line_width: 2,
          line_opacity: 0.8,
          line_style: "solid",
          polygon_fill_color: "#ff7800",
          polygon_fill_opacity: 0.3,
          polygon_stroke_color: "#ff7800",
          polygon_stroke_width: 2,
          polygon_stroke_style: "solid",
          cluster_enabled: true,
          cluster_icon_color: "#ffffff",
          cluster_text_color: "#000000"
        }
      }
    }
  }
}

module.exports = new ConfigService()
```

#### 2.1.3 修改后端控制器
**修改文件**: `/server/src/controllers/pointStyle.controller.js`

```javascript
// ... existing code ...
// 替换原有的数据库查询逻辑
// 将所有数据库操作替换为ConfigService调用

const ConfigService = require('../services/ConfigService')

class PointStyleController {
  static async getVideoPointStyles(req, res) {
    try {
      const styles = await ConfigService.getPointStyles('video')
      res.json({
        success: true,
        data: styles,
        message: '获取视频点位样式配置成功'
      })
    } catch (error) {
      console.error('获取视频点位样式配置失败:', error)
      res.status(500).json({
        success: false,
        message: '获取视频点位样式配置失败',
        error: error.message
      })
    }
  }

  static async updateVideoPointStyles(req, res) {
    try {
      const success = await ConfigService.updatePointStyles('video', req.body)
      if (success) {
        const updatedStyles = await ConfigService.getPointStyles('video')
        res.json({
          success: true,
          data: updatedStyles,
          message: '更新视频点位样式配置成功'
        })
      } else {
        throw new Error('保存配置失败')
      }
    } catch (error) {
      console.error('更新视频点位样式配置失败:', error)
      res.status(500).json({
        success: false,
        message: '更新视频点位样式配置失败',
        error: error.message
      })
    }
  }

  // 类似地修改其他方法...
}
```

#### 2.1.4 修改KML文件控制器
**修改文件**: `/server/src/controllers/kmlFile.controller.js`

```javascript
// ... existing code ...
// 在相关方法中替换样式配置的数据库操作
// 将KmlFileStyleModel的调用替换为ConfigService调用

static async getKmlFileStyles(req, res) {
  try {
    const { id } = req.params
    const styles = await ConfigService.getKmlStyles(id)
    
    res.json({
      success: true,
      data: styles,
      message: '获取KML文件样式配置成功'
    })
  } catch (error) {
    console.error('获取KML文件样式配置失败:', error)
    res.status(500).json({
      success: false,
      message: '获取样式配置失败',
      error: error.message
    })
  }
}

static async updateKmlFileStyles(req, res) {
  try {
    const { id } = req.params
    const styleConfig = req.body
    
    const success = await ConfigService.updateKmlStyles(id, styleConfig)
    if (success) {
      const styles = await ConfigService.getKmlStyles(id)
      res.json({
        success: true,
        message: '样式配置更新成功',
        data: styles
      })
    } else {
      throw new Error('保存配置失败')
    }
  } catch (error) {
    console.error('更新KML文件样式配置失败:', error)
    res.status(500).json({
      success: false,
      message: '更新样式配置失败',
      error: error.message
    })
  }
}
```

### 2.2 第二阶段：数据库重构

#### 2.2.1 移除样式配置相关表
**需要移除的表**:
- `kml_file_styles`
- `panorama_point_styles`
- `video_point_styles`

#### 2.2.2 创建统一的数据库初始化脚本
**新建文件**: `/scripts/unified-database.sql`

```sql
-- 地图全景系统统一数据库脚本
-- 版本: 2.0.0
-- 创建时间: 2024-01-01

-- 创建数据库
CREATE DATABASE IF NOT EXISTS panorama_map 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE panorama_map;

-- 1. 创建文件夹表
CREATE TABLE IF NOT EXISTS folders (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL COMMENT '文件夹名称',
  parent_id INT DEFAULT NULL COMMENT '父文件夹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT '是否可见',
  sort_order INT DEFAULT 0 COMMENT '排序顺序',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  FOREIGN KEY (parent_id) REFERENCES folders(id) ON DELETE CASCADE,
  INDEX idx_parent_id (parent_id),
  INDEX idx_name (name),
  INDEX idx_sort_order (sort_order),
  INDEX idx_is_visible (is_visible)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文件夹表';

-- 2. 创建全景图表
CREATE TABLE IF NOT EXISTS panoramas (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL COMMENT '全景图标题',
  description TEXT COMMENT '全景图描述',
  image_url VARCHAR(500) NOT NULL COMMENT '全景图URL',
  thumbnail_url VARCHAR(500) COMMENT '缩略图URL',
  latitude DECIMAL(10, 8) NOT NULL COMMENT '纬度(WGS84)',
  longitude DECIMAL(11, 8) NOT NULL COMMENT '经度(WGS84)',
  gcj02_lat DECIMAL(10, 8) COMMENT '纬度(GCJ02)',
  gcj02_lng DECIMAL(11, 8) COMMENT '经度(GCJ02)',
  file_size BIGINT COMMENT '文件大小(字节)',
  file_type VARCHAR(100) COMMENT '文件类型',
  folder_id INT DEFAULT NULL COMMENT '所属文件夹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT '是否可见',
  sort_order INT DEFAULT 0 COMMENT '排序',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE SET NULL,
  INDEX idx_location (latitude, longitude),
  INDEX idx_gcj02_location (gcj02_lat, gcj02_lng),
  INDEX idx_folder_id (folder_id),
  INDEX idx_is_visible (is_visible),
  INDEX idx_created_at (created_at),
  INDEX idx_title (title),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='全景图表';

-- 3. 创建视频点位表
CREATE TABLE IF NOT EXISTS video_points (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL COMMENT '视频标题',
  description TEXT COMMENT '视频描述',
  video_url VARCHAR(500) NOT NULL COMMENT '视频文件URL',
  thumbnail_url VARCHAR(500) COMMENT '视频缩略图URL',
  latitude DECIMAL(10, 8) NOT NULL COMMENT '纬度(WGS84)',
  longitude DECIMAL(11, 8) NOT NULL COMMENT '经度(WGS84)',
  gcj02_lat DECIMAL(10, 8) COMMENT '纬度(GCJ02)',
  gcj02_lng DECIMAL(11, 8) COMMENT '经度(GCJ02)',
  file_size BIGINT COMMENT '文件大小(字节)',
  file_type VARCHAR(100) COMMENT '文件类型',
  duration INT COMMENT '视频时长(秒)',
  folder_id INT DEFAULT NULL COMMENT '所属文件夹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT '是否可见',
  sort_order INT DEFAULT 0 COMMENT '排序',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE SET NULL,
  INDEX idx_latitude (latitude),
  INDEX idx_longitude (longitude),
  INDEX idx_gcj02_lat (gcj02_lat),
  INDEX idx_gcj02_lng (gcj02_lng),
  INDEX idx_folder_id (folder_id),
  INDEX idx_is_visible (is_visible),
  INDEX idx_created_at (created_at),
  INDEX idx_title (title),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='视频点位表';

-- 4. 创建KML文件表
CREATE TABLE IF NOT EXISTS kml_files (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL COMMENT 'KML文件标题',
  description TEXT COMMENT 'KML文件描述',
  file_url VARCHAR(500) NOT NULL COMMENT 'KML文件URL',
  file_size BIGINT COMMENT '文件大小(字节)',
  folder_id INT DEFAULT NULL COMMENT '所属文件夹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT '是否可见',
  sort_order INT DEFAULT 0 COMMENT '排序',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE SET NULL,
  INDEX idx_folder_id (folder_id),
  INDEX idx_is_visible (is_visible),
  INDEX idx_created_at (created_at),
  INDEX idx_title (title),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='KML文件表';

-- 5. 创建KML点位表
CREATE TABLE IF NOT EXISTS kml_points (
  id INT PRIMARY KEY AUTO_INCREMENT,
  kml_file_id INT NOT NULL COMMENT '所属KML文件ID',
  name VARCHAR(255) COMMENT '点位名称',
  description TEXT COMMENT '点位描述',
  latitude DECIMAL(10, 8) NOT NULL COMMENT '纬度(WGS84)',
  longitude DECIMAL(11, 8) NOT NULL COMMENT '经度(WGS84)',
  gcj02_lat DECIMAL(10, 8) COMMENT '纬度(GCJ02)',
  gcj02_lng DECIMAL(11, 8) COMMENT '经度(GCJ02)',
  altitude DECIMAL(10, 2) DEFAULT 0 COMMENT '海拔高度',
  point_type ENUM('Point', 'LineString', 'Polygon') DEFAULT 'Point' COMMENT '几何类型',
  coordinates TEXT COMMENT '完整坐标数据(JSON格式)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  
  FOREIGN KEY (kml_file_id) REFERENCES kml_files(id) ON DELETE CASCADE,
  INDEX idx_kml_file_id (kml_file_id),
  INDEX idx_latitude (latitude),
  INDEX idx_longitude (longitude),
  INDEX idx_gcj02_lat (gcj02_lat),
  INDEX idx_gcj02_lng (gcj02_lng),
  INDEX idx_point_type (point_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='KML点位表';

-- 6. 插入默认文件夹
INSERT INTO folders (name, parent_id, is_visible, sort_order) VALUES
('默认文件夹', NULL, TRUE, 0),
('北京景点', NULL, TRUE, 1),
('历史建筑', 2, TRUE, 0),
('现代建筑', 2, TRUE, 1)
ON DUPLICATE KEY UPDATE name = VALUES(name);

-- 7. 插入示例全景图数据
INSERT INTO panoramas (title, description, image_url, thumbnail_url, latitude, longitude, gcj02_lat, gcj02_lng, file_size, file_type, folder_id) VALUES
('天安门广场', '北京天安门广场全景图', '/uploads/panoramas/sample1.jpg', '/uploads/thumbnails/sample1.jpg', 39.9042, 116.4074, 39.9042, 116.4074, 2048000, 'image/jpeg', 3),
('故宫太和殿', '北京故宫太和殿全景图', '/uploads/panoramas/sample2.jpg', '/uploads/thumbnails/sample2.jpg', 39.9163, 116.3972, 39.9163, 116.3972, 1856000, 'image/jpeg', 3),
('颐和园昆明湖', '北京颐和园昆明湖全景图', '/uploads/panoramas/sample3.jpg', '/uploads/thumbnails/sample3.jpg', 39.9999, 116.2755, 39.9999, 116.2755, 2304000, 'image/jpeg', 3),
('长城八达岭', '北京八达岭长城全景图', '/uploads/panoramas/sample4.jpg', '/uploads/thumbnails/sample4.jpg', 40.3584, 116.0138, 40.3584, 116.0138, 2560000, 'image/jpeg', 3),
('鸟巢体育场', '北京国家体育场(鸟巢)全景图', '/uploads/panoramas/sample5.jpg', '/uploads/thumbnails/sample5.jpg', 39.9928, 116.3975, 39.9928, 116.3975, 1792000, 'image/jpeg', 4)
ON DUPLICATE KEY UPDATE title = VALUES(title);

-- 8. 插入示例视频点位数据
INSERT INTO video_points (title, description, video_url, latitude, longitude, gcj02_lat, gcj02_lng, file_size, file_type, duration, folder_id) VALUES
('天安门广场视频', '北京天安门广场实时视频', '/uploads/videos/sample1.mp4', 39.9042, 116.4074, 39.9042, 116.4074, 10485760, 'video/mp4', 120, 3),
('故宫太和殿视频', '北京故宫太和殿介绍视频', '/uploads/videos/sample2.mp4', 39.9163, 116.3972, 39.9163, 116.3972, 8388608, 'video/mp4', 90, 3),
('颐和园昆明湖视频', '北京颐和园昆明湖风景视频', '/uploads/videos/sample3.mp4', 39.9999, 116.2755, 39.9999, 116.2755, 12582912, 'video/mp4', 150, 3)
ON DUPLICATE KEY UPDATE title = VALUES(title);

COMMIT;
```

#### 2.2.3 创建数据迁移脚本
**新建文件**: `/scripts/migrate-config-to-files.js`

```javascript
const mysql = require('mysql2/promise')
const fs = require('fs').promises
const path = require('path')

class ConfigMigrator {
  constructor() {
    this.dbConfig = {
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || 'asd123123123',
      database: process.env.DB_NAME || 'panorama_map'
    }
    this.configPath = path.join(__dirname, '../server/config/app-config.json')
  }

  async migrateStyles() {
    let connection
    try {
      connection = await mysql.createConnection(this.dbConfig)
      console.log('连接数据库成功')

      // 读取现有配置
      let appConfig = {
        version: "1.0.0",
        pointStyles: {},
        kmlStyles: {},
        mapSettings: {
          defaultCenter: [116.4074, 39.9042],
          defaultZoom: 12,
          minZoom: 3,
          maxZoom: 18,
          mapType: "normal"
        }
      }

      // 迁移全景图点位样式
      try {
        const [panoramaStyles] = await connection.execute('SELECT * FROM panorama_point_styles LIMIT 1')
        if (panoramaStyles.length > 0) {
          const style = panoramaStyles[0]
          appConfig.pointStyles.panorama = {
            point_color: style.point_color,
            point_size: style.point_size,
            point_opacity: style.point_opacity,
            point_icon_type: style.point_icon_type,
            point_label_size: style.point_label_size,
            point_label_color: style.point_label_color
          }
          console.log('迁移全景图点位样式成功')
        }
      } catch (error) {
        console.log('全景图点位样式表不存在，使用默认配置')
        appConfig.pointStyles.panorama = {
          point_color: "#2ed573",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "circle",
          point_label_size: 12,
          point_label_color: "#000000"
        }
      }

      // 迁移视频点位样式
      try {
        const [videoStyles] = await connection.execute('SELECT * FROM video_point_styles LIMIT 1')
        if (videoStyles.length > 0) {
          const style = videoStyles[0]
          appConfig.pointStyles.video = {
            point_color: style.point_color,
            point_size: style.point_size,
            point_opacity: style.point_opacity,
            point_icon_type: style.point_icon_type,
            point_label_size: style.point_label_size,
            point_label_color: style.point_label_color
          }
          console.log('迁移视频点位样式成功')
        }
      } catch (error) {
        console.log('视频点位样式表不存在，使用默认配置')
        appConfig.pointStyles.video = {
          point_color: "#ff4757",
          point_size: 10,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 14,
          point_label_color: "#000000"
        }
      }

      // 迁移KML文件样式
      try {
        const [kmlStyles] = await connection.execute('SELECT * FROM kml_file_styles')
        appConfig.kmlStyles.default = {
          point_color: "#ff7800",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 12,
          point_label_color: "#000000",
          line_color: "#ff7800",
          line_width: 2,
          line_opacity: 0.8,
          line_style: "solid",
          polygon_fill_color: "#ff7800",
          polygon_fill_opacity: 0.3,
          polygon_stroke_color: "#ff7800",
          polygon_stroke_width: 2,
          polygon_stroke_style: "solid",
          cluster_enabled: true,
          cluster_icon_color: "#ffffff",
          cluster_text_color: "#000000"
        }

        if (kmlStyles.length > 0) {
          for (const style of kmlStyles) {
            appConfig.kmlStyles[style.kml_file_id] = {
              point_color: style.point_color,
              point_size: style.point_size,
              point_opacity: style.point_opacity,
              point_icon_type: style.point_icon_type,
              point_label_size: style.point_label_size,
              point_label_color: style.point_label_color,
              line_color: style.line_color,
              line_width: style.line_width,
              line_opacity: style.line_opacity,
              line_style: style.line_style,
              polygon_fill_color: style.polygon_fill_color,
              polygon_fill_opacity: style.polygon_fill_opacity,
              polygon_stroke_color: style.polygon_stroke_color,
              polygon_stroke_width: style.polygon_stroke_width,
              polygon_stroke_style: style.polygon_stroke_style,
              cluster_enabled: style.cluster_enabled,
              cluster_icon_color: style.cluster_icon_color,
              cluster_text_color: style.cluster_text_color
            }
          }
          console.log(`迁移 ${kmlStyles.length} 个KML文件样式成功`)
        }
      } catch (error) {
        console.log('KML文件样式表不存在，使用默认配置')
      }

      // 保存配置文件
      await fs.writeFile(this.configPath, JSON.stringify(appConfig, null, 2))
      console.log('配置文件保存成功:', this.configPath)

      return appConfig
    } catch (error) {
      console.error('迁移配置失败:', error)
      throw error
    } finally {
      if (connection) {
        await connection.end()
      }
    }
  }

  async dropStyleTables() {
    let connection
    try {
      connection = await mysql.createConnection(this.dbConfig)
      
      const tables = [
        'kml_file_styles',
        'panorama_point_styles', 
        'video_point_styles'
      ]

      for (const table of tables) {
        try {
          await connection.execute(`DROP TABLE IF EXISTS ${table}`)
          console.log(`删除表 ${table} 成功`)
        } catch (error) {
          console.log(`表 ${table} 不存在或已删除`)
        }
      }
    } catch (error) {
      console.error('删除样式表失败:', error)
      throw error
    } finally {
      if (connection) {
        await connection.end()
      }
    }
  }
}

module.exports = ConfigMigrator

// 如果直接运行此脚本
if (require.main === module) {
  const migrator = new ConfigMigrator()
  
  async function main() {
    try {
      console.log('开始迁移配置...')
      await migrator.migrateStyles()
      
      console.log('是否删除样式配置表? (y/N)')
      process.stdin.setEncoding('utf8')
      process.stdin.on('readable', async () => {
        const chunk = process.stdin.read()
        if (chunk !== null) {
          const answer = chunk.trim().toLowerCase()
          if (answer === 'y' || answer === 'yes') {
            await migrator.dropStyleTables()
            console.log('迁移完成！')
          } else {
            console.log('保留样式配置表，迁移完成！')
          }
          process.exit(0)
        }
      })
    } catch (error) {
      console.error('迁移失败:', error)
      process.exit(1)
    }
  }
  
  main()
}
```

### 2.3 第三阶段：前端重构

#### 2.3.1 更新前端配置管理
**修改文件**: `/client/src/composables/usePointStyles.js`

```javascript
import { ref } from 'vue'
import { pointStyleApi } from '@/api/pointStyle.js'

export function usePointStyles() {
  const loading = ref(false)
  
  // 样式配置缓存
  const videoPointStyles = ref({
    point_color: '#ff4757',
    point_size: 10,
    point_opacity: 1.0,
    point_icon_type: 'marker',
    point_label_size: 14,
    point_label_color: '#000000'
  })
  
  const panoramaPointStyles = ref({
    point_color: '#2ed573',
    point_size: 8,
    point_opacity: 1.0,
    point_icon_type: 'circle',
    point_label_size: 12,
    point_label_color: '#000000'
  })

  // 初始化本地存储缓存
  const initLocalCache = () => {
    try {
      const cached = localStorage.getItem('pointStyles')
      if (cached) {
        const styles = JSON.parse(cached)
        if (styles.video) videoPointStyles.value = styles.video
        if (styles.panorama) panoramaPointStyles.value = styles.panorama
      }
    } catch (error) {
      console.warn('读取本地样式缓存失败:', error)
    }
  }

  // 保存到本地存储
  const saveToLocalCache = () => {
    try {
      const styles = {
        video: videoPointStyles.value,
        panorama: panoramaPointStyles.value,
        lastUpdated: Date.now()
      }
      localStorage.setItem('pointStyles', JSON.stringify(styles))
    } catch (error) {
      console.warn('保存本地样式缓存失败:', error)
    }
  }

  // 加载视频点位样式
  const loadVideoPointStyles = async (useCache = true) => {
    try {
      // 检查本地缓存
      if (useCache) {
        const cached = localStorage.getItem('pointStyles')
        if (cached) {
          const styles = JSON.parse(cached)
          const cacheAge = Date.now() - (styles.lastUpdated || 0)
          // 缓存有效期为1小时
          if (cacheAge < 3600000 && styles.video) {
            videoPointStyles.value = styles.video
            return styles.video
          }
        }
      }

      loading.value = true
      const response = await pointStyleApi.getVideoStyles()
      videoPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('加载视频点位样式失败:', error)
      return videoPointStyles.value // 返回默认样式
    } finally {
      loading.value = false
    }
  }

  // 加载全景图点位样式
  const loadPanoramaPointStyles = async (useCache = true) => {
    try {
      // 检查本地缓存
      if (useCache) {
        const cached = localStorage.getItem('pointStyles')
        if (cached) {
          const styles = JSON.parse(cached)
          const cacheAge = Date.now() - (styles.lastUpdated || 0)
          if (cacheAge < 3600000 && styles.panorama) {
            panoramaPointStyles.value = styles.panorama
            return styles.panorama
          }
        }
      }

      loading.value = true
      const response = await pointStyleApi.getPanoramaStyles()
      panoramaPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('加载全景图点位样式失败:', error)
      return panoramaPointStyles.value
    } finally {
      loading.value = false
    }
  }

  // 更新视频点位样式
  const updateVideoPointStyles = async (styleConfig) => {
    try {
      loading.value = true
      const response = await pointStyleApi.updateVideoStyles(styleConfig)
      videoPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('更新视频点位样式失败:', error)
      throw error
    } finally {
      loading.value = false
    }
  }

  // 更新全景图点位样式
  const updatePanoramaPointStyles = async (styleConfig) => {
    try {
      loading.value = true
      const response = await pointStyleApi.updatePanoramaStyles(styleConfig)
      panoramaPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('更新全景图点位样式失败:', error)
      throw error
    } finally {
      loading.value = false
    }
  }

  // 初始化
  initLocalCache()

  return {
    loading,
    videoPointStyles,
    panoramaPointStyles,
    loadVideoPointStyles,
    loadPanoramaPointStyles,
    updateVideoPointStyles,
    updatePanoramaPointStyles,
    loadAllPointStyles: async (useCache = true) => {
      await Promise.all([
        loadVideoPointStyles(useCache),
        loadPanoramaPointStyles(useCache)
      ])
    },
    clearCache: () => {
      localStorage.removeItem('pointStyles')
    }
  }
}
```

#### 2.3.2 创建配置管理组件
**新建文件**: `/client/src/components/admin/ConfigManager.vue`

```vue
<template>
  <div class="config-manager">
    <el-card class="config-card">
      <template #header>
        <div class="card-header">
          <span>系统配置管理</span>
          <el-button 
            type="primary" 
            @click="saveAllConfigs"
            :loading="saving"
          >
            保存所有配置
          </el-button>
        </div>
      </template>

      <el-tabs v-model="activeTab" type="border-card">
        <!-- 点位样式配置 -->
        <el-tab-pane label="点位样式" name="pointStyles">
          <div class="config-section">
            <h3>全景图点位样式</h3>
            <point-style-editor 
              v-model="config.pointStyles.panorama"
              @change="markConfigChanged('pointStyles')"
            />
            
            <h3>视频点位样式</h3>
            <point-style-editor 
              v-model="config.pointStyles.video"
              @change="markConfigChanged('pointStyles')"
            />
          </div>
        </el-tab-pane>

        <!-- KML样式配置 -->
        <el-tab-pane label="KML样式" name="kmlStyles">
          <div class="config-section">
            <h3>默认KML样式</h3>
            <kml-style-editor 
              v-model="config.kmlStyles.default"
              @change="markConfigChanged('kmlStyles')"
            />
          </div>
        </el-tab-pane>

        <!-- 地图设置 -->
        <el-tab-pane label="地图设置" name="mapSettings">
          <div class="config-section">
            <el-form :model="config.mapSettings" label-width="120px">
              <el-form-item label="默认中心点">
                <base-coordinate-input 
                  v-model="config.mapSettings.defaultCenter"
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
              
              <el-form-item label="默认缩放级别">
                <el-slider
                  v-model="config.mapSettings.defaultZoom"
                  :min="3"
                  :max="18"
                  show-input
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
              
              <el-form-item label="最小缩放级别">
                <el-slider
                  v-model="config.mapSettings.minZoom"
                  :min="1"
                  :max="10"
                  show-input
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
              
              <el-form-item label="最大缩放级别">
                <el-slider
                  v-model="config.mapSettings.maxZoom"
                  :min="15"
                  :max="20"
                  show-input
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
            </el-form>
          </div>
        </el-tab-pane>

        <!-- 上传设置 -->
        <el-tab-pane label="上传设置" name="uploadSettings">
          <div class="config-section">
            <el-form :model="config.uploadSettings" label-width="120px">
              <el-form-item label="最大文件大小">
                <el-input-number
                  v-model="config.uploadSettings.maxFileSize"
                  :min="1048576"
                  :max="1073741824"
                  :step="1048576"
                  @change="markConfigChanged('uploadSettings')"
                />
                <span class="unit">字节</span>
              </el-form-item>
              
              <el-form-item label="缩略图尺寸">
                <div class="size-inputs">
                  <el-input-number
                    v-model="config.uploadSettings.thumbnailSize.width"
                    :min="100"
                    :max="800"
                    @change="markConfigChanged('uploadSettings')"
                  />
                  <span>×</span>
                  <el-input-number
                    v-model="config.uploadSettings.thumbnailSize.height"
                    :min="100"
                    :max="600"
                    @change="markConfigChanged('uploadSettings')"
                  />
                </div>
              </el-form-item>
            </el-form>
          </div>
        </el-tab-pane>
      </el-tabs>
    </el-card>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { configApi } from '@/api/config.js'

const activeTab = ref('pointStyles')
const saving = ref(false)
const changedSections = ref(new Set())

const config = reactive({
  pointStyles: {
    panorama: {},
    video: {}
  },
  kmlStyles: {
    default: {}
  },
  mapSettings: {},
  uploadSettings: {}
})

const loadConfig = async () => {
  try {
    const response = await configApi.getConfig()
    Object.assign(config, response.data)
  } catch (error) {
    console.error('加载配置失败:', error)
    ElMessage.error('加载配置失败')
  }
}

const markConfigChanged = (section) => {
  changedSections.value.add(section)
}

const saveAllConfigs = async () => {
  if (changedSections.value.size === 0) {
    ElMessage.info('没有配置需要保存')
    return
  }

  try {
    await ElMessageBox.confirm('确定要保存配置更改吗？', '确认保存', {
      type: 'warning'
    })

    saving.value = true
    await configApi.updateConfig(config)
    changedSections.value.clear()
    ElMessage.success('配置保存成功')
  } catch (error) {
    if (error !== 'cancel') {
      console.error('保存配置失败:', error)
      ElMessage.error('保存配置失败')
    }
  } finally {
    saving.value = false
  }
}

onMounted(() => {
  loadConfig()
})
</script>
```

### 2.4 第四阶段：清理和优化

#### 2.4.1 移除旧文件
**需要删除的文件**:
- `/server/src/models/kmlFileStyle.model.js`
- `/server/src/models/panoramaPointStyle.model.js`
- `/server/src/models/videoPointStyle.model.js`
- `/scripts/add-kml-style-feature.sql`
- `/scripts/add-point-style-feature.sql`
- `/scripts/add-video-points-table.sql`
- `/scripts/add-media-points-feature.sql`
- `/scripts/add-folder-feature.sql`
- `/scripts/init-db.sql`
- `/setup-mysql.sql`

#### 2.4.2 更新部署脚本
**修改文件**: `/auto-install-mysql.sh`

```bash
# ... existing code ...

# 初始化数据库
init_database() {
    log_info "初始化数据库..."
    
    # 检查unified-database.sql文件是否存在
    if [[ ! -f "scripts/unified-database.sql" ]]; then
        log_error "未找到 scripts/unified-database.sql 文件"
        return 1
    fi
    
    # 设置字符编码
    docker exec ${CONTAINER_NAME} mysql -u root -p${DB_PASSWORD} -e "SET GLOBAL character_set_client = utf8mb4; SET GLOBAL character_set_connection = utf8mb4; SET GLOBAL character_set_results = utf8mb4;"
    
    # 导入数据库结构和数据
    if docker exec -i ${CONTAINER_NAME} mysql -u root -p${DB_PASSWORD} ${DB_NAME} --default-character-set=utf8mb4 < scripts/unified-database.sql; then
        log_success "数据库初始化完成"
    else
        log_error "数据库初始化失败"
        return 1
    fi
    
    # 初始化配置文件
    log_info "初始化配置文件..."
    if [[ ! -f "server/config/app-config.json" ]]; then
        node scripts/migrate-config-to-files.js --init-only
        log_success "配置文件初始化完成"
    fi
}
```

#### 2.4.3 创建重构验证脚本
**新建文件**: `/scripts/verify-refactor.js`

```javascript
const fs = require('fs').promises
const path = require('path')
const mysql = require('mysql2/promise')

class RefactorVerifier {
  constructor() {
    this.dbConfig = {
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || 'asd123123123',
      database: process.env.DB_NAME || 'panorama_map'
    }
    this.configPath = path.join(__dirname, '../server/config/app-config.json')
  }

  async verifyDatabase() {
    let connection
    try {
      connection = await mysql.createConnection(this.dbConfig)
      console.log('✓ 数据库连接成功')

      // 检查核心表是否存在
      const requiredTables = [
        'folders', 'panoramas', 'video_points', 
        'kml_files', 'kml_points'
      ]

      for (const table of requiredTables) {
        const [rows] = await connection.execute(`SHOW TABLES LIKE '${table}'`)
        if (rows.length > 0) {
          console.log(`✓ 表 ${table} 存在`)
        } else {
          console.log(`✗ 表 ${table} 不存在`)
          return false
        }
      }

      // 检查样式表是否已删除
      const styleTables = [
        'kml_file_styles', 'panorama_point_styles', 'video_point_styles'
      ]

      for (const table of styleTables) {
        const [rows] = await connection.execute(`SHOW TABLES LIKE '${table}'`)
        if (rows.length === 0) {
          console.log(`✓ 样式表 ${table} 已删除`)
        } else {
          console.log(`⚠ 样式表 ${table} 仍然存在`)
        }
      }

      return true
    } catch (error) {
      console.error('✗ 数据库验证失败:', error)
      return false
    } finally {
      if (connection) {
        await connection.end()
      }
    }
  }

  async verifyConfigFile() {
    try {
      const configExists = await fs.access(this.configPath).then(() => true).catch(() => false)
      if (!configExists) {
        console.log('✗ 配置文件不存在')
        return false
      }

      const configData = await fs.readFile(this.configPath, 'utf8')
      const config = JSON.parse(configData)

      // 检查必要的配置节
      const requiredSections = ['pointStyles', 'kmlStyles', 'mapSettings']
      for (const section of requiredSections) {
        if (config[section]) {
          console.log(`✓ 配置节 ${section} 存在`)
        } else {
          console.log(`✗ 配置节 ${section} 不存在`)
          return false
        }
      }

      // 检查点位样式配置
      if (config.pointStyles.panorama && config.pointStyles.video) {
        console.log('✓ 点位样式配置完整')
      } else {
        console.log('✗ 点位样式配置不完整')
        return false
      }

      console.log('✓ 配置文件验证成功')
      return true
    } catch (error) {
      console.error('✗ 配置文件验证失败:', error)
      return false
    }
  }

  async verifyCodeChanges() {
    try {
      // 检查ConfigService是否存在
      const serviceExists = await fs.access(
        path.join(__dirname, '../server/src/services/ConfigService.js')
      ).then(() => true).catch(() => false)

      if (serviceExists) {
        console.log('✓ ConfigService 文件存在')
      } else {
        console.log('✗ ConfigService 文件不存在')
        return false
      }

      // 检查旧模型文件是否已删除
      const oldModels = [
        '../server/src/models/kmlFileStyle.model.js',
        '../server/src/models/panoramaPointStyle.model.js',
        '../server/src/models/videoPointStyle.model.js'
      ]

      for (const model of oldModels) {
        const exists = await fs.access(path.join(__dirname, model)).then(() => true).catch(() => false)
        if (!exists) {
          console.log(`✓ 旧模型文件 ${path.basename(model)} 已删除`)
        } else {
          console.log(`⚠ 旧模型文件 ${path.basename(model)} 仍然存在`)
        }
      }

      console.log('✓ 代码变更验证完成')
      return true
    } catch (error) {
      console.error('✗ 代码变更验证失败:', error)
      return false
    }
  }

  async runFullVerification() {
    console.log('开始重构验证...\n')

    const dbResult = await this.verifyDatabase()
    console.log('')
    
    const configResult = await this.verifyConfigFile()
    console.log('')
    
    const codeResult = await this.verifyCodeChanges()
    console.log('')

    if (dbResult && configResult && codeResult) {
      console.log('🎉 重构验证成功！所有检查项都通过。')
      return true
    } else {
      console.log('❌ 重构验证失败！请检查上述问题。')
      return false
    }
  }
}

module.exports = RefactorVerifier

if (require.main === module) {
  const verifier = new RefactorVerifier()
  verifier.runFullVerification().then(success => {
    process.exit(success ? 0 : 1)
  })
}
```
