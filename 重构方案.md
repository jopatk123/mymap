
# åœ°å›¾å…¨æ™¯ç³»ç»Ÿé‡æ„æ–¹æ¡ˆ

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 å½“å‰æ¶æ„åˆ†æ
- **åç«¯**: Node.js + Express + MySQL
- **å‰ç«¯**: Vue 3 + Vite + Element Plus
- **æ•°æ®å­˜å‚¨**: 
  - å…¨æ™¯å›¾æ•°æ®ï¼ˆpanoramasè¡¨ï¼‰
  - è§†é¢‘ç‚¹ä½æ•°æ®ï¼ˆvideo_pointsè¡¨ï¼‰
  - KMLæ–‡ä»¶æ•°æ®ï¼ˆkml_filesè¡¨ + kml_pointsè¡¨ï¼‰
  - æ ·å¼é…ç½®æ•°æ®ï¼ˆå¤šä¸ªæ ·å¼é…ç½®è¡¨ï¼‰

### 1.2 é‡æ„ç›®æ ‡
1. **é…ç½®æ–‡ä»¶åŒ–**: å°†æ•°æ®åº“ä¸­çš„é…ç½®æ•°æ®è¿ç§»åˆ°JSONæ–‡ä»¶
2. **æ•°æ®åº“ç®€åŒ–**: æ•´ç†å’Œç»Ÿä¸€æ•°æ®åº“è„šæœ¬ï¼Œç§»é™¤é…ç½®ç›¸å…³è¡¨
3. **æ¶æ„ä¼˜åŒ–**: æ”¹å–„é…ç½®ç®¡ç†æœºåˆ¶ï¼Œæé«˜æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§

## 2. è¯¦ç»†é‡æ„è®¡åˆ’

### 2.1 ç¬¬ä¸€é˜¶æ®µï¼šé…ç½®æ–‡ä»¶é‡æ„

#### 2.1.1 åˆ›å»ºé…ç½®æ–‡ä»¶ç»“æ„
**æ–°å»ºæ–‡ä»¶**: `/server/config/app-config.json`

```json
{
  "version": "1.0.0",
  "pointStyles": {
    "panorama": {
      "point_color": "#2ed573",
      "point_size": 8,
      "point_opacity": 1.0,
      "point_icon_type": "circle",
      "point_label_size": 12,
      "point_label_color": "#000000"
    },
    "video": {
      "point_color": "#ff4757",
      "point_size": 10,
      "point_opacity": 1.0,
      "point_icon_type": "marker",
      "point_label_size": 14,
      "point_label_color": "#000000"
    }
  },
  "kmlStyles": {
    "default": {
      "point_color": "#ff7800",
      "point_size": 8,
      "point_opacity": 1.0,
      "point_icon_type": "marker",
      "point_label_size": 12,
      "point_label_color": "#000000",
      "line_color": "#ff7800",
      "line_width": 2,
      "line_opacity": 0.8,
      "line_style": "solid",
      "polygon_fill_color": "#ff7800",
      "polygon_fill_opacity": 0.3,
      "polygon_stroke_color": "#ff7800",
      "polygon_stroke_width": 2,
      "polygon_stroke_style": "solid",
      "cluster_enabled": true,
      "cluster_icon_color": "#ffffff",
      "cluster_text_color": "#000000"
    }
  },
  "mapSettings": {
    "defaultCenter": [116.4074, 39.9042],
    "defaultZoom": 12,
    "minZoom": 3,
    "maxZoom": 18,
    "mapType": "normal"
  },
  "uploadSettings": {
    "maxFileSize": 104857600,
    "allowedImageTypes": ["jpg", "jpeg", "png"],
    "allowedVideoTypes": ["mp4", "avi", "mov"],
    "allowedKmlTypes": ["kml", "kmz"],
    "thumbnailSize": {
      "width": 300,
      "height": 200
    }
  }
}
```

#### 2.1.2 åˆ›å»ºé…ç½®ç®¡ç†æœåŠ¡
**æ–°å»ºæ–‡ä»¶**: `/server/src/services/ConfigService.js`

```javascript
const fs = require('fs').promises
const path = require('path')

class ConfigService {
  constructor() {
    this.configPath = path.join(__dirname, '../../config/app-config.json')
    this.config = null
    this.lastModified = null
  }

  async loadConfig() {
    try {
      const stats = await fs.stat(this.configPath)
      if (!this.config || stats.mtime > this.lastModified) {
        const data = await fs.readFile(this.configPath, 'utf8')
        this.config = JSON.parse(data)
        this.lastModified = stats.mtime
      }
      return this.config
    } catch (error) {
      console.error('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥:', error)
      return this.getDefaultConfig()
    }
  }

  async saveConfig(newConfig) {
    try {
      await fs.writeFile(this.configPath, JSON.stringify(newConfig, null, 2))
      this.config = newConfig
      this.lastModified = new Date()
      return true
    } catch (error) {
      console.error('ä¿å­˜é…ç½®æ–‡ä»¶å¤±è´¥:', error)
      return false
    }
  }

  async getPointStyles(type) {
    const config = await this.loadConfig()
    return config.pointStyles[type] || config.pointStyles.panorama
  }

  async updatePointStyles(type, styles) {
    const config = await this.loadConfig()
    config.pointStyles[type] = { ...config.pointStyles[type], ...styles }
    return await this.saveConfig(config)
  }

  async getKmlStyles(fileId = 'default') {
    const config = await this.loadConfig()
    return config.kmlStyles[fileId] || config.kmlStyles.default
  }

  async updateKmlStyles(fileId, styles) {
    const config = await this.loadConfig()
    config.kmlStyles[fileId] = { ...config.kmlStyles[fileId] || config.kmlStyles.default, ...styles }
    return await this.saveConfig(config)
  }

  getDefaultConfig() {
    // è¿”å›ç¡¬ç¼–ç çš„é»˜è®¤é…ç½®
    return {
      version: "1.0.0",
      pointStyles: {
        panorama: {
          point_color: "#2ed573",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "circle",
          point_label_size: 12,
          point_label_color: "#000000"
        },
        video: {
          point_color: "#ff4757",
          point_size: 10,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 14,
          point_label_color: "#000000"
        }
      },
      kmlStyles: {
        default: {
          point_color: "#ff7800",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 12,
          point_label_color: "#000000",
          line_color: "#ff7800",
          line_width: 2,
          line_opacity: 0.8,
          line_style: "solid",
          polygon_fill_color: "#ff7800",
          polygon_fill_opacity: 0.3,
          polygon_stroke_color: "#ff7800",
          polygon_stroke_width: 2,
          polygon_stroke_style: "solid",
          cluster_enabled: true,
          cluster_icon_color: "#ffffff",
          cluster_text_color: "#000000"
        }
      }
    }
  }
}

module.exports = new ConfigService()
```

#### 2.1.3 ä¿®æ”¹åç«¯æ§åˆ¶å™¨
**ä¿®æ”¹æ–‡ä»¶**: `/server/src/controllers/pointStyle.controller.js`

```javascript
// ... existing code ...
// æ›¿æ¢åŸæœ‰çš„æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
// å°†æ‰€æœ‰æ•°æ®åº“æ“ä½œæ›¿æ¢ä¸ºConfigServiceè°ƒç”¨

const ConfigService = require('../services/ConfigService')

class PointStyleController {
  static async getVideoPointStyles(req, res) {
    try {
      const styles = await ConfigService.getPointStyles('video')
      res.json({
        success: true,
        data: styles,
        message: 'è·å–è§†é¢‘ç‚¹ä½æ ·å¼é…ç½®æˆåŠŸ'
      })
    } catch (error) {
      console.error('è·å–è§†é¢‘ç‚¹ä½æ ·å¼é…ç½®å¤±è´¥:', error)
      res.status(500).json({
        success: false,
        message: 'è·å–è§†é¢‘ç‚¹ä½æ ·å¼é…ç½®å¤±è´¥',
        error: error.message
      })
    }
  }

  static async updateVideoPointStyles(req, res) {
    try {
      const success = await ConfigService.updatePointStyles('video', req.body)
      if (success) {
        const updatedStyles = await ConfigService.getPointStyles('video')
        res.json({
          success: true,
          data: updatedStyles,
          message: 'æ›´æ–°è§†é¢‘ç‚¹ä½æ ·å¼é…ç½®æˆåŠŸ'
        })
      } else {
        throw new Error('ä¿å­˜é…ç½®å¤±è´¥')
      }
    } catch (error) {
      console.error('æ›´æ–°è§†é¢‘ç‚¹ä½æ ·å¼é…ç½®å¤±è´¥:', error)
      res.status(500).json({
        success: false,
        message: 'æ›´æ–°è§†é¢‘ç‚¹ä½æ ·å¼é…ç½®å¤±è´¥',
        error: error.message
      })
    }
  }

  // ç±»ä¼¼åœ°ä¿®æ”¹å…¶ä»–æ–¹æ³•...
}
```

#### 2.1.4 ä¿®æ”¹KMLæ–‡ä»¶æ§åˆ¶å™¨
**ä¿®æ”¹æ–‡ä»¶**: `/server/src/controllers/kmlFile.controller.js`

```javascript
// ... existing code ...
// åœ¨ç›¸å…³æ–¹æ³•ä¸­æ›¿æ¢æ ·å¼é…ç½®çš„æ•°æ®åº“æ“ä½œ
// å°†KmlFileStyleModelçš„è°ƒç”¨æ›¿æ¢ä¸ºConfigServiceè°ƒç”¨

static async getKmlFileStyles(req, res) {
  try {
    const { id } = req.params
    const styles = await ConfigService.getKmlStyles(id)
    
    res.json({
      success: true,
      data: styles,
      message: 'è·å–KMLæ–‡ä»¶æ ·å¼é…ç½®æˆåŠŸ'
    })
  } catch (error) {
    console.error('è·å–KMLæ–‡ä»¶æ ·å¼é…ç½®å¤±è´¥:', error)
    res.status(500).json({
      success: false,
      message: 'è·å–æ ·å¼é…ç½®å¤±è´¥',
      error: error.message
    })
  }
}

static async updateKmlFileStyles(req, res) {
  try {
    const { id } = req.params
    const styleConfig = req.body
    
    const success = await ConfigService.updateKmlStyles(id, styleConfig)
    if (success) {
      const styles = await ConfigService.getKmlStyles(id)
      res.json({
        success: true,
        message: 'æ ·å¼é…ç½®æ›´æ–°æˆåŠŸ',
        data: styles
      })
    } else {
      throw new Error('ä¿å­˜é…ç½®å¤±è´¥')
    }
  } catch (error) {
    console.error('æ›´æ–°KMLæ–‡ä»¶æ ·å¼é…ç½®å¤±è´¥:', error)
    res.status(500).json({
      success: false,
      message: 'æ›´æ–°æ ·å¼é…ç½®å¤±è´¥',
      error: error.message
    })
  }
}
```

### 2.2 ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“é‡æ„

#### 2.2.1 ç§»é™¤æ ·å¼é…ç½®ç›¸å…³è¡¨
**éœ€è¦ç§»é™¤çš„è¡¨**:
- `kml_file_styles`
- `panorama_point_styles`
- `video_point_styles`

#### 2.2.2 åˆ›å»ºç»Ÿä¸€çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
**æ–°å»ºæ–‡ä»¶**: `/scripts/unified-database.sql`

```sql
-- åœ°å›¾å…¨æ™¯ç³»ç»Ÿç»Ÿä¸€æ•°æ®åº“è„šæœ¬
-- ç‰ˆæœ¬: 2.0.0
-- åˆ›å»ºæ—¶é—´: 2024-01-01

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS panorama_map 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE panorama_map;

-- 1. åˆ›å»ºæ–‡ä»¶å¤¹è¡¨
CREATE TABLE IF NOT EXISTS folders (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL COMMENT 'æ–‡ä»¶å¤¹åç§°',
  parent_id INT DEFAULT NULL COMMENT 'çˆ¶æ–‡ä»¶å¤¹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯è§',
  sort_order INT DEFAULT 0 COMMENT 'æ’åºé¡ºåº',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  FOREIGN KEY (parent_id) REFERENCES folders(id) ON DELETE CASCADE,
  INDEX idx_parent_id (parent_id),
  INDEX idx_name (name),
  INDEX idx_sort_order (sort_order),
  INDEX idx_is_visible (is_visible)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ–‡ä»¶å¤¹è¡¨';

-- 2. åˆ›å»ºå…¨æ™¯å›¾è¡¨
CREATE TABLE IF NOT EXISTS panoramas (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL COMMENT 'å…¨æ™¯å›¾æ ‡é¢˜',
  description TEXT COMMENT 'å…¨æ™¯å›¾æè¿°',
  image_url VARCHAR(500) NOT NULL COMMENT 'å…¨æ™¯å›¾URL',
  thumbnail_url VARCHAR(500) COMMENT 'ç¼©ç•¥å›¾URL',
  latitude DECIMAL(10, 8) NOT NULL COMMENT 'çº¬åº¦(WGS84)',
  longitude DECIMAL(11, 8) NOT NULL COMMENT 'ç»åº¦(WGS84)',
  gcj02_lat DECIMAL(10, 8) COMMENT 'çº¬åº¦(GCJ02)',
  gcj02_lng DECIMAL(11, 8) COMMENT 'ç»åº¦(GCJ02)',
  file_size BIGINT COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
  file_type VARCHAR(100) COMMENT 'æ–‡ä»¶ç±»å‹',
  folder_id INT DEFAULT NULL COMMENT 'æ‰€å±æ–‡ä»¶å¤¹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯è§',
  sort_order INT DEFAULT 0 COMMENT 'æ’åº',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE SET NULL,
  INDEX idx_location (latitude, longitude),
  INDEX idx_gcj02_location (gcj02_lat, gcj02_lng),
  INDEX idx_folder_id (folder_id),
  INDEX idx_is_visible (is_visible),
  INDEX idx_created_at (created_at),
  INDEX idx_title (title),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å…¨æ™¯å›¾è¡¨';

-- 3. åˆ›å»ºè§†é¢‘ç‚¹ä½è¡¨
CREATE TABLE IF NOT EXISTS video_points (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL COMMENT 'è§†é¢‘æ ‡é¢˜',
  description TEXT COMMENT 'è§†é¢‘æè¿°',
  video_url VARCHAR(500) NOT NULL COMMENT 'è§†é¢‘æ–‡ä»¶URL',
  thumbnail_url VARCHAR(500) COMMENT 'è§†é¢‘ç¼©ç•¥å›¾URL',
  latitude DECIMAL(10, 8) NOT NULL COMMENT 'çº¬åº¦(WGS84)',
  longitude DECIMAL(11, 8) NOT NULL COMMENT 'ç»åº¦(WGS84)',
  gcj02_lat DECIMAL(10, 8) COMMENT 'çº¬åº¦(GCJ02)',
  gcj02_lng DECIMAL(11, 8) COMMENT 'ç»åº¦(GCJ02)',
  file_size BIGINT COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
  file_type VARCHAR(100) COMMENT 'æ–‡ä»¶ç±»å‹',
  duration INT COMMENT 'è§†é¢‘æ—¶é•¿(ç§’)',
  folder_id INT DEFAULT NULL COMMENT 'æ‰€å±æ–‡ä»¶å¤¹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯è§',
  sort_order INT DEFAULT 0 COMMENT 'æ’åº',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE SET NULL,
  INDEX idx_latitude (latitude),
  INDEX idx_longitude (longitude),
  INDEX idx_gcj02_lat (gcj02_lat),
  INDEX idx_gcj02_lng (gcj02_lng),
  INDEX idx_folder_id (folder_id),
  INDEX idx_is_visible (is_visible),
  INDEX idx_created_at (created_at),
  INDEX idx_title (title),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è§†é¢‘ç‚¹ä½è¡¨';

-- 4. åˆ›å»ºKMLæ–‡ä»¶è¡¨
CREATE TABLE IF NOT EXISTS kml_files (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255) NOT NULL COMMENT 'KMLæ–‡ä»¶æ ‡é¢˜',
  description TEXT COMMENT 'KMLæ–‡ä»¶æè¿°',
  file_url VARCHAR(500) NOT NULL COMMENT 'KMLæ–‡ä»¶URL',
  file_size BIGINT COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
  folder_id INT DEFAULT NULL COMMENT 'æ‰€å±æ–‡ä»¶å¤¹ID',
  is_visible BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯è§',
  sort_order INT DEFAULT 0 COMMENT 'æ’åº',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE SET NULL,
  INDEX idx_folder_id (folder_id),
  INDEX idx_is_visible (is_visible),
  INDEX idx_created_at (created_at),
  INDEX idx_title (title),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='KMLæ–‡ä»¶è¡¨';

-- 5. åˆ›å»ºKMLç‚¹ä½è¡¨
CREATE TABLE IF NOT EXISTS kml_points (
  id INT PRIMARY KEY AUTO_INCREMENT,
  kml_file_id INT NOT NULL COMMENT 'æ‰€å±KMLæ–‡ä»¶ID',
  name VARCHAR(255) COMMENT 'ç‚¹ä½åç§°',
  description TEXT COMMENT 'ç‚¹ä½æè¿°',
  latitude DECIMAL(10, 8) NOT NULL COMMENT 'çº¬åº¦(WGS84)',
  longitude DECIMAL(11, 8) NOT NULL COMMENT 'ç»åº¦(WGS84)',
  gcj02_lat DECIMAL(10, 8) COMMENT 'çº¬åº¦(GCJ02)',
  gcj02_lng DECIMAL(11, 8) COMMENT 'ç»åº¦(GCJ02)',
  altitude DECIMAL(10, 2) DEFAULT 0 COMMENT 'æµ·æ‹”é«˜åº¦',
  point_type ENUM('Point', 'LineString', 'Polygon') DEFAULT 'Point' COMMENT 'å‡ ä½•ç±»å‹',
  coordinates TEXT COMMENT 'å®Œæ•´åæ ‡æ•°æ®(JSONæ ¼å¼)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  
  FOREIGN KEY (kml_file_id) REFERENCES kml_files(id) ON DELETE CASCADE,
  INDEX idx_kml_file_id (kml_file_id),
  INDEX idx_latitude (latitude),
  INDEX idx_longitude (longitude),
  INDEX idx_gcj02_lat (gcj02_lat),
  INDEX idx_gcj02_lng (gcj02_lng),
  INDEX idx_point_type (point_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='KMLç‚¹ä½è¡¨';

-- 6. æ’å…¥é»˜è®¤æ–‡ä»¶å¤¹
INSERT INTO folders (name, parent_id, is_visible, sort_order) VALUES
('é»˜è®¤æ–‡ä»¶å¤¹', NULL, TRUE, 0),
('åŒ—äº¬æ™¯ç‚¹', NULL, TRUE, 1),
('å†å²å»ºç­‘', 2, TRUE, 0),
('ç°ä»£å»ºç­‘', 2, TRUE, 1)
ON DUPLICATE KEY UPDATE name = VALUES(name);

-- 7. æ’å…¥ç¤ºä¾‹å…¨æ™¯å›¾æ•°æ®
INSERT INTO panoramas (title, description, image_url, thumbnail_url, latitude, longitude, gcj02_lat, gcj02_lng, file_size, file_type, folder_id) VALUES
('å¤©å®‰é—¨å¹¿åœº', 'åŒ—äº¬å¤©å®‰é—¨å¹¿åœºå…¨æ™¯å›¾', '/uploads/panoramas/sample1.jpg', '/uploads/thumbnails/sample1.jpg', 39.9042, 116.4074, 39.9042, 116.4074, 2048000, 'image/jpeg', 3),
('æ•…å®«å¤ªå’Œæ®¿', 'åŒ—äº¬æ•…å®«å¤ªå’Œæ®¿å…¨æ™¯å›¾', '/uploads/panoramas/sample2.jpg', '/uploads/thumbnails/sample2.jpg', 39.9163, 116.3972, 39.9163, 116.3972, 1856000, 'image/jpeg', 3),
('é¢å’Œå›­æ˜†æ˜æ¹–', 'åŒ—äº¬é¢å’Œå›­æ˜†æ˜æ¹–å…¨æ™¯å›¾', '/uploads/panoramas/sample3.jpg', '/uploads/thumbnails/sample3.jpg', 39.9999, 116.2755, 39.9999, 116.2755, 2304000, 'image/jpeg', 3),
('é•¿åŸå…«è¾¾å²­', 'åŒ—äº¬å…«è¾¾å²­é•¿åŸå…¨æ™¯å›¾', '/uploads/panoramas/sample4.jpg', '/uploads/thumbnails/sample4.jpg', 40.3584, 116.0138, 40.3584, 116.0138, 2560000, 'image/jpeg', 3),
('é¸Ÿå·¢ä½“è‚²åœº', 'åŒ—äº¬å›½å®¶ä½“è‚²åœº(é¸Ÿå·¢)å…¨æ™¯å›¾', '/uploads/panoramas/sample5.jpg', '/uploads/thumbnails/sample5.jpg', 39.9928, 116.3975, 39.9928, 116.3975, 1792000, 'image/jpeg', 4)
ON DUPLICATE KEY UPDATE title = VALUES(title);

-- 8. æ’å…¥ç¤ºä¾‹è§†é¢‘ç‚¹ä½æ•°æ®
INSERT INTO video_points (title, description, video_url, latitude, longitude, gcj02_lat, gcj02_lng, file_size, file_type, duration, folder_id) VALUES
('å¤©å®‰é—¨å¹¿åœºè§†é¢‘', 'åŒ—äº¬å¤©å®‰é—¨å¹¿åœºå®æ—¶è§†é¢‘', '/uploads/videos/sample1.mp4', 39.9042, 116.4074, 39.9042, 116.4074, 10485760, 'video/mp4', 120, 3),
('æ•…å®«å¤ªå’Œæ®¿è§†é¢‘', 'åŒ—äº¬æ•…å®«å¤ªå’Œæ®¿ä»‹ç»è§†é¢‘', '/uploads/videos/sample2.mp4', 39.9163, 116.3972, 39.9163, 116.3972, 8388608, 'video/mp4', 90, 3),
('é¢å’Œå›­æ˜†æ˜æ¹–è§†é¢‘', 'åŒ—äº¬é¢å’Œå›­æ˜†æ˜æ¹–é£æ™¯è§†é¢‘', '/uploads/videos/sample3.mp4', 39.9999, 116.2755, 39.9999, 116.2755, 12582912, 'video/mp4', 150, 3)
ON DUPLICATE KEY UPDATE title = VALUES(title);

COMMIT;
```

#### 2.2.3 åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬
**æ–°å»ºæ–‡ä»¶**: `/scripts/migrate-config-to-files.js`

```javascript
const mysql = require('mysql2/promise')
const fs = require('fs').promises
const path = require('path')

class ConfigMigrator {
  constructor() {
    this.dbConfig = {
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || 'asd123123123',
      database: process.env.DB_NAME || 'panorama_map'
    }
    this.configPath = path.join(__dirname, '../server/config/app-config.json')
  }

  async migrateStyles() {
    let connection
    try {
      connection = await mysql.createConnection(this.dbConfig)
      console.log('è¿æ¥æ•°æ®åº“æˆåŠŸ')

      // è¯»å–ç°æœ‰é…ç½®
      let appConfig = {
        version: "1.0.0",
        pointStyles: {},
        kmlStyles: {},
        mapSettings: {
          defaultCenter: [116.4074, 39.9042],
          defaultZoom: 12,
          minZoom: 3,
          maxZoom: 18,
          mapType: "normal"
        }
      }

      // è¿ç§»å…¨æ™¯å›¾ç‚¹ä½æ ·å¼
      try {
        const [panoramaStyles] = await connection.execute('SELECT * FROM panorama_point_styles LIMIT 1')
        if (panoramaStyles.length > 0) {
          const style = panoramaStyles[0]
          appConfig.pointStyles.panorama = {
            point_color: style.point_color,
            point_size: style.point_size,
            point_opacity: style.point_opacity,
            point_icon_type: style.point_icon_type,
            point_label_size: style.point_label_size,
            point_label_color: style.point_label_color
          }
          console.log('è¿ç§»å…¨æ™¯å›¾ç‚¹ä½æ ·å¼æˆåŠŸ')
        }
      } catch (error) {
        console.log('å…¨æ™¯å›¾ç‚¹ä½æ ·å¼è¡¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')
        appConfig.pointStyles.panorama = {
          point_color: "#2ed573",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "circle",
          point_label_size: 12,
          point_label_color: "#000000"
        }
      }

      // è¿ç§»è§†é¢‘ç‚¹ä½æ ·å¼
      try {
        const [videoStyles] = await connection.execute('SELECT * FROM video_point_styles LIMIT 1')
        if (videoStyles.length > 0) {
          const style = videoStyles[0]
          appConfig.pointStyles.video = {
            point_color: style.point_color,
            point_size: style.point_size,
            point_opacity: style.point_opacity,
            point_icon_type: style.point_icon_type,
            point_label_size: style.point_label_size,
            point_label_color: style.point_label_color
          }
          console.log('è¿ç§»è§†é¢‘ç‚¹ä½æ ·å¼æˆåŠŸ')
        }
      } catch (error) {
        console.log('è§†é¢‘ç‚¹ä½æ ·å¼è¡¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')
        appConfig.pointStyles.video = {
          point_color: "#ff4757",
          point_size: 10,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 14,
          point_label_color: "#000000"
        }
      }

      // è¿ç§»KMLæ–‡ä»¶æ ·å¼
      try {
        const [kmlStyles] = await connection.execute('SELECT * FROM kml_file_styles')
        appConfig.kmlStyles.default = {
          point_color: "#ff7800",
          point_size: 8,
          point_opacity: 1.0,
          point_icon_type: "marker",
          point_label_size: 12,
          point_label_color: "#000000",
          line_color: "#ff7800",
          line_width: 2,
          line_opacity: 0.8,
          line_style: "solid",
          polygon_fill_color: "#ff7800",
          polygon_fill_opacity: 0.3,
          polygon_stroke_color: "#ff7800",
          polygon_stroke_width: 2,
          polygon_stroke_style: "solid",
          cluster_enabled: true,
          cluster_icon_color: "#ffffff",
          cluster_text_color: "#000000"
        }

        if (kmlStyles.length > 0) {
          for (const style of kmlStyles) {
            appConfig.kmlStyles[style.kml_file_id] = {
              point_color: style.point_color,
              point_size: style.point_size,
              point_opacity: style.point_opacity,
              point_icon_type: style.point_icon_type,
              point_label_size: style.point_label_size,
              point_label_color: style.point_label_color,
              line_color: style.line_color,
              line_width: style.line_width,
              line_opacity: style.line_opacity,
              line_style: style.line_style,
              polygon_fill_color: style.polygon_fill_color,
              polygon_fill_opacity: style.polygon_fill_opacity,
              polygon_stroke_color: style.polygon_stroke_color,
              polygon_stroke_width: style.polygon_stroke_width,
              polygon_stroke_style: style.polygon_stroke_style,
              cluster_enabled: style.cluster_enabled,
              cluster_icon_color: style.cluster_icon_color,
              cluster_text_color: style.cluster_text_color
            }
          }
          console.log(`è¿ç§» ${kmlStyles.length} ä¸ªKMLæ–‡ä»¶æ ·å¼æˆåŠŸ`)
        }
      } catch (error) {
        console.log('KMLæ–‡ä»¶æ ·å¼è¡¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')
      }

      // ä¿å­˜é…ç½®æ–‡ä»¶
      await fs.writeFile(this.configPath, JSON.stringify(appConfig, null, 2))
      console.log('é…ç½®æ–‡ä»¶ä¿å­˜æˆåŠŸ:', this.configPath)

      return appConfig
    } catch (error) {
      console.error('è¿ç§»é…ç½®å¤±è´¥:', error)
      throw error
    } finally {
      if (connection) {
        await connection.end()
      }
    }
  }

  async dropStyleTables() {
    let connection
    try {
      connection = await mysql.createConnection(this.dbConfig)
      
      const tables = [
        'kml_file_styles',
        'panorama_point_styles', 
        'video_point_styles'
      ]

      for (const table of tables) {
        try {
          await connection.execute(`DROP TABLE IF EXISTS ${table}`)
          console.log(`åˆ é™¤è¡¨ ${table} æˆåŠŸ`)
        } catch (error) {
          console.log(`è¡¨ ${table} ä¸å­˜åœ¨æˆ–å·²åˆ é™¤`)
        }
      }
    } catch (error) {
      console.error('åˆ é™¤æ ·å¼è¡¨å¤±è´¥:', error)
      throw error
    } finally {
      if (connection) {
        await connection.end()
      }
    }
  }
}

module.exports = ConfigMigrator

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬
if (require.main === module) {
  const migrator = new ConfigMigrator()
  
  async function main() {
    try {
      console.log('å¼€å§‹è¿ç§»é…ç½®...')
      await migrator.migrateStyles()
      
      console.log('æ˜¯å¦åˆ é™¤æ ·å¼é…ç½®è¡¨? (y/N)')
      process.stdin.setEncoding('utf8')
      process.stdin.on('readable', async () => {
        const chunk = process.stdin.read()
        if (chunk !== null) {
          const answer = chunk.trim().toLowerCase()
          if (answer === 'y' || answer === 'yes') {
            await migrator.dropStyleTables()
            console.log('è¿ç§»å®Œæˆï¼')
          } else {
            console.log('ä¿ç•™æ ·å¼é…ç½®è¡¨ï¼Œè¿ç§»å®Œæˆï¼')
          }
          process.exit(0)
        }
      })
    } catch (error) {
      console.error('è¿ç§»å¤±è´¥:', error)
      process.exit(1)
    }
  }
  
  main()
}
```

### 2.3 ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯é‡æ„

#### 2.3.1 æ›´æ–°å‰ç«¯é…ç½®ç®¡ç†
**ä¿®æ”¹æ–‡ä»¶**: `/client/src/composables/usePointStyles.js`

```javascript
import { ref } from 'vue'
import { pointStyleApi } from '@/api/pointStyle.js'

export function usePointStyles() {
  const loading = ref(false)
  
  // æ ·å¼é…ç½®ç¼“å­˜
  const videoPointStyles = ref({
    point_color: '#ff4757',
    point_size: 10,
    point_opacity: 1.0,
    point_icon_type: 'marker',
    point_label_size: 14,
    point_label_color: '#000000'
  })
  
  const panoramaPointStyles = ref({
    point_color: '#2ed573',
    point_size: 8,
    point_opacity: 1.0,
    point_icon_type: 'circle',
    point_label_size: 12,
    point_label_color: '#000000'
  })

  // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨ç¼“å­˜
  const initLocalCache = () => {
    try {
      const cached = localStorage.getItem('pointStyles')
      if (cached) {
        const styles = JSON.parse(cached)
        if (styles.video) videoPointStyles.value = styles.video
        if (styles.panorama) panoramaPointStyles.value = styles.panorama
      }
    } catch (error) {
      console.warn('è¯»å–æœ¬åœ°æ ·å¼ç¼“å­˜å¤±è´¥:', error)
    }
  }

  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  const saveToLocalCache = () => {
    try {
      const styles = {
        video: videoPointStyles.value,
        panorama: panoramaPointStyles.value,
        lastUpdated: Date.now()
      }
      localStorage.setItem('pointStyles', JSON.stringify(styles))
    } catch (error) {
      console.warn('ä¿å­˜æœ¬åœ°æ ·å¼ç¼“å­˜å¤±è´¥:', error)
    }
  }

  // åŠ è½½è§†é¢‘ç‚¹ä½æ ·å¼
  const loadVideoPointStyles = async (useCache = true) => {
    try {
      // æ£€æŸ¥æœ¬åœ°ç¼“å­˜
      if (useCache) {
        const cached = localStorage.getItem('pointStyles')
        if (cached) {
          const styles = JSON.parse(cached)
          const cacheAge = Date.now() - (styles.lastUpdated || 0)
          // ç¼“å­˜æœ‰æ•ˆæœŸä¸º1å°æ—¶
          if (cacheAge < 3600000 && styles.video) {
            videoPointStyles.value = styles.video
            return styles.video
          }
        }
      }

      loading.value = true
      const response = await pointStyleApi.getVideoStyles()
      videoPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('åŠ è½½è§†é¢‘ç‚¹ä½æ ·å¼å¤±è´¥:', error)
      return videoPointStyles.value // è¿”å›é»˜è®¤æ ·å¼
    } finally {
      loading.value = false
    }
  }

  // åŠ è½½å…¨æ™¯å›¾ç‚¹ä½æ ·å¼
  const loadPanoramaPointStyles = async (useCache = true) => {
    try {
      // æ£€æŸ¥æœ¬åœ°ç¼“å­˜
      if (useCache) {
        const cached = localStorage.getItem('pointStyles')
        if (cached) {
          const styles = JSON.parse(cached)
          const cacheAge = Date.now() - (styles.lastUpdated || 0)
          if (cacheAge < 3600000 && styles.panorama) {
            panoramaPointStyles.value = styles.panorama
            return styles.panorama
          }
        }
      }

      loading.value = true
      const response = await pointStyleApi.getPanoramaStyles()
      panoramaPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('åŠ è½½å…¨æ™¯å›¾ç‚¹ä½æ ·å¼å¤±è´¥:', error)
      return panoramaPointStyles.value
    } finally {
      loading.value = false
    }
  }

  // æ›´æ–°è§†é¢‘ç‚¹ä½æ ·å¼
  const updateVideoPointStyles = async (styleConfig) => {
    try {
      loading.value = true
      const response = await pointStyleApi.updateVideoStyles(styleConfig)
      videoPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('æ›´æ–°è§†é¢‘ç‚¹ä½æ ·å¼å¤±è´¥:', error)
      throw error
    } finally {
      loading.value = false
    }
  }

  // æ›´æ–°å…¨æ™¯å›¾ç‚¹ä½æ ·å¼
  const updatePanoramaPointStyles = async (styleConfig) => {
    try {
      loading.value = true
      const response = await pointStyleApi.updatePanoramaStyles(styleConfig)
      panoramaPointStyles.value = response.data
      saveToLocalCache()
      return response.data
    } catch (error) {
      console.error('æ›´æ–°å…¨æ™¯å›¾ç‚¹ä½æ ·å¼å¤±è´¥:', error)
      throw error
    } finally {
      loading.value = false
    }
  }

  // åˆå§‹åŒ–
  initLocalCache()

  return {
    loading,
    videoPointStyles,
    panoramaPointStyles,
    loadVideoPointStyles,
    loadPanoramaPointStyles,
    updateVideoPointStyles,
    updatePanoramaPointStyles,
    loadAllPointStyles: async (useCache = true) => {
      await Promise.all([
        loadVideoPointStyles(useCache),
        loadPanoramaPointStyles(useCache)
      ])
    },
    clearCache: () => {
      localStorage.removeItem('pointStyles')
    }
  }
}
```

#### 2.3.2 åˆ›å»ºé…ç½®ç®¡ç†ç»„ä»¶
**æ–°å»ºæ–‡ä»¶**: `/client/src/components/admin/ConfigManager.vue`

```vue
<template>
  <div class="config-manager">
    <el-card class="config-card">
      <template #header>
        <div class="card-header">
          <span>ç³»ç»Ÿé…ç½®ç®¡ç†</span>
          <el-button 
            type="primary" 
            @click="saveAllConfigs"
            :loading="saving"
          >
            ä¿å­˜æ‰€æœ‰é…ç½®
          </el-button>
        </div>
      </template>

      <el-tabs v-model="activeTab" type="border-card">
        <!-- ç‚¹ä½æ ·å¼é…ç½® -->
        <el-tab-pane label="ç‚¹ä½æ ·å¼" name="pointStyles">
          <div class="config-section">
            <h3>å…¨æ™¯å›¾ç‚¹ä½æ ·å¼</h3>
            <point-style-editor 
              v-model="config.pointStyles.panorama"
              @change="markConfigChanged('pointStyles')"
            />
            
            <h3>è§†é¢‘ç‚¹ä½æ ·å¼</h3>
            <point-style-editor 
              v-model="config.pointStyles.video"
              @change="markConfigChanged('pointStyles')"
            />
          </div>
        </el-tab-pane>

        <!-- KMLæ ·å¼é…ç½® -->
        <el-tab-pane label="KMLæ ·å¼" name="kmlStyles">
          <div class="config-section">
            <h3>é»˜è®¤KMLæ ·å¼</h3>
            <kml-style-editor 
              v-model="config.kmlStyles.default"
              @change="markConfigChanged('kmlStyles')"
            />
          </div>
        </el-tab-pane>

        <!-- åœ°å›¾è®¾ç½® -->
        <el-tab-pane label="åœ°å›¾è®¾ç½®" name="mapSettings">
          <div class="config-section">
            <el-form :model="config.mapSettings" label-width="120px">
              <el-form-item label="é»˜è®¤ä¸­å¿ƒç‚¹">
                <base-coordinate-input 
                  v-model="config.mapSettings.defaultCenter"
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
              
              <el-form-item label="é»˜è®¤ç¼©æ”¾çº§åˆ«">
                <el-slider
                  v-model="config.mapSettings.defaultZoom"
                  :min="3"
                  :max="18"
                  show-input
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
              
              <el-form-item label="æœ€å°ç¼©æ”¾çº§åˆ«">
                <el-slider
                  v-model="config.mapSettings.minZoom"
                  :min="1"
                  :max="10"
                  show-input
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
              
              <el-form-item label="æœ€å¤§ç¼©æ”¾çº§åˆ«">
                <el-slider
                  v-model="config.mapSettings.maxZoom"
                  :min="15"
                  :max="20"
                  show-input
                  @change="markConfigChanged('mapSettings')"
                />
              </el-form-item>
            </el-form>
          </div>
        </el-tab-pane>

        <!-- ä¸Šä¼ è®¾ç½® -->
        <el-tab-pane label="ä¸Šä¼ è®¾ç½®" name="uploadSettings">
          <div class="config-section">
            <el-form :model="config.uploadSettings" label-width="120px">
              <el-form-item label="æœ€å¤§æ–‡ä»¶å¤§å°">
                <el-input-number
                  v-model="config.uploadSettings.maxFileSize"
                  :min="1048576"
                  :max="1073741824"
                  :step="1048576"
                  @change="markConfigChanged('uploadSettings')"
                />
                <span class="unit">å­—èŠ‚</span>
              </el-form-item>
              
              <el-form-item label="ç¼©ç•¥å›¾å°ºå¯¸">
                <div class="size-inputs">
                  <el-input-number
                    v-model="config.uploadSettings.thumbnailSize.width"
                    :min="100"
                    :max="800"
                    @change="markConfigChanged('uploadSettings')"
                  />
                  <span>Ã—</span>
                  <el-input-number
                    v-model="config.uploadSettings.thumbnailSize.height"
                    :min="100"
                    :max="600"
                    @change="markConfigChanged('uploadSettings')"
                  />
                </div>
              </el-form-item>
            </el-form>
          </div>
        </el-tab-pane>
      </el-tabs>
    </el-card>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { configApi } from '@/api/config.js'

const activeTab = ref('pointStyles')
const saving = ref(false)
const changedSections = ref(new Set())

const config = reactive({
  pointStyles: {
    panorama: {},
    video: {}
  },
  kmlStyles: {
    default: {}
  },
  mapSettings: {},
  uploadSettings: {}
})

const loadConfig = async () => {
  try {
    const response = await configApi.getConfig()
    Object.assign(config, response.data)
  } catch (error) {
    console.error('åŠ è½½é…ç½®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½é…ç½®å¤±è´¥')
  }
}

const markConfigChanged = (section) => {
  changedSections.value.add(section)
}

const saveAllConfigs = async () => {
  if (changedSections.value.size === 0) {
    ElMessage.info('æ²¡æœ‰é…ç½®éœ€è¦ä¿å­˜')
    return
  }

  try {
    await ElMessageBox.confirm('ç¡®å®šè¦ä¿å­˜é…ç½®æ›´æ”¹å—ï¼Ÿ', 'ç¡®è®¤ä¿å­˜', {
      type: 'warning'
    })

    saving.value = true
    await configApi.updateConfig(config)
    changedSections.value.clear()
    ElMessage.success('é…ç½®ä¿å­˜æˆåŠŸ')
  } catch (error) {
    if (error !== 'cancel') {
      console.error('ä¿å­˜é…ç½®å¤±è´¥:', error)
      ElMessage.error('ä¿å­˜é…ç½®å¤±è´¥')
    }
  } finally {
    saving.value = false
  }
}

onMounted(() => {
  loadConfig()
})
</script>
```

### 2.4 ç¬¬å››é˜¶æ®µï¼šæ¸…ç†å’Œä¼˜åŒ–

#### 2.4.1 ç§»é™¤æ—§æ–‡ä»¶
**éœ€è¦åˆ é™¤çš„æ–‡ä»¶**:
- `/server/src/models/kmlFileStyle.model.js`
- `/server/src/models/panoramaPointStyle.model.js`
- `/server/src/models/videoPointStyle.model.js`
- `/scripts/add-kml-style-feature.sql`
- `/scripts/add-point-style-feature.sql`
- `/scripts/add-video-points-table.sql`
- `/scripts/add-media-points-feature.sql`
- `/scripts/add-folder-feature.sql`
- `/scripts/init-db.sql`
- `/setup-mysql.sql`

#### 2.4.2 æ›´æ–°éƒ¨ç½²è„šæœ¬
**ä¿®æ”¹æ–‡ä»¶**: `/auto-install-mysql.sh`

```bash
# ... existing code ...

# åˆå§‹åŒ–æ•°æ®åº“
init_database() {
    log_info "åˆå§‹åŒ–æ•°æ®åº“..."
    
    # æ£€æŸ¥unified-database.sqlæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [[ ! -f "scripts/unified-database.sql" ]]; then
        log_error "æœªæ‰¾åˆ° scripts/unified-database.sql æ–‡ä»¶"
        return 1
    fi
    
    # è®¾ç½®å­—ç¬¦ç¼–ç 
    docker exec ${CONTAINER_NAME} mysql -u root -p${DB_PASSWORD} -e "SET GLOBAL character_set_client = utf8mb4; SET GLOBAL character_set_connection = utf8mb4; SET GLOBAL character_set_results = utf8mb4;"
    
    # å¯¼å…¥æ•°æ®åº“ç»“æ„å’Œæ•°æ®
    if docker exec -i ${CONTAINER_NAME} mysql -u root -p${DB_PASSWORD} ${DB_NAME} --default-character-set=utf8mb4 < scripts/unified-database.sql; then
        log_success "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
    else
        log_error "æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥"
        return 1
    fi
    
    # åˆå§‹åŒ–é…ç½®æ–‡ä»¶
    log_info "åˆå§‹åŒ–é…ç½®æ–‡ä»¶..."
    if [[ ! -f "server/config/app-config.json" ]]; then
        node scripts/migrate-config-to-files.js --init-only
        log_success "é…ç½®æ–‡ä»¶åˆå§‹åŒ–å®Œæˆ"
    fi
}
```

#### 2.4.3 åˆ›å»ºé‡æ„éªŒè¯è„šæœ¬
**æ–°å»ºæ–‡ä»¶**: `/scripts/verify-refactor.js`

```javascript
const fs = require('fs').promises
const path = require('path')
const mysql = require('mysql2/promise')

class RefactorVerifier {
  constructor() {
    this.dbConfig = {
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || 'asd123123123',
      database: process.env.DB_NAME || 'panorama_map'
    }
    this.configPath = path.join(__dirname, '../server/config/app-config.json')
  }

  async verifyDatabase() {
    let connection
    try {
      connection = await mysql.createConnection(this.dbConfig)
      console.log('âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ')

      // æ£€æŸ¥æ ¸å¿ƒè¡¨æ˜¯å¦å­˜åœ¨
      const requiredTables = [
        'folders', 'panoramas', 'video_points', 
        'kml_files', 'kml_points'
      ]

      for (const table of requiredTables) {
        const [rows] = await connection.execute(`SHOW TABLES LIKE '${table}'`)
        if (rows.length > 0) {
          console.log(`âœ“ è¡¨ ${table} å­˜åœ¨`)
        } else {
          console.log(`âœ— è¡¨ ${table} ä¸å­˜åœ¨`)
          return false
        }
      }

      // æ£€æŸ¥æ ·å¼è¡¨æ˜¯å¦å·²åˆ é™¤
      const styleTables = [
        'kml_file_styles', 'panorama_point_styles', 'video_point_styles'
      ]

      for (const table of styleTables) {
        const [rows] = await connection.execute(`SHOW TABLES LIKE '${table}'`)
        if (rows.length === 0) {
          console.log(`âœ“ æ ·å¼è¡¨ ${table} å·²åˆ é™¤`)
        } else {
          console.log(`âš  æ ·å¼è¡¨ ${table} ä»ç„¶å­˜åœ¨`)
        }
      }

      return true
    } catch (error) {
      console.error('âœ— æ•°æ®åº“éªŒè¯å¤±è´¥:', error)
      return false
    } finally {
      if (connection) {
        await connection.end()
      }
    }
  }

  async verifyConfigFile() {
    try {
      const configExists = await fs.access(this.configPath).then(() => true).catch(() => false)
      if (!configExists) {
        console.log('âœ— é…ç½®æ–‡ä»¶ä¸å­˜åœ¨')
        return false
      }

      const configData = await fs.readFile(this.configPath, 'utf8')
      const config = JSON.parse(configData)

      // æ£€æŸ¥å¿…è¦çš„é…ç½®èŠ‚
      const requiredSections = ['pointStyles', 'kmlStyles', 'mapSettings']
      for (const section of requiredSections) {
        if (config[section]) {
          console.log(`âœ“ é…ç½®èŠ‚ ${section} å­˜åœ¨`)
        } else {
          console.log(`âœ— é…ç½®èŠ‚ ${section} ä¸å­˜åœ¨`)
          return false
        }
      }

      // æ£€æŸ¥ç‚¹ä½æ ·å¼é…ç½®
      if (config.pointStyles.panorama && config.pointStyles.video) {
        console.log('âœ“ ç‚¹ä½æ ·å¼é…ç½®å®Œæ•´')
      } else {
        console.log('âœ— ç‚¹ä½æ ·å¼é…ç½®ä¸å®Œæ•´')
        return false
      }

      console.log('âœ“ é…ç½®æ–‡ä»¶éªŒè¯æˆåŠŸ')
      return true
    } catch (error) {
      console.error('âœ— é…ç½®æ–‡ä»¶éªŒè¯å¤±è´¥:', error)
      return false
    }
  }

  async verifyCodeChanges() {
    try {
      // æ£€æŸ¥ConfigServiceæ˜¯å¦å­˜åœ¨
      const serviceExists = await fs.access(
        path.join(__dirname, '../server/src/services/ConfigService.js')
      ).then(() => true).catch(() => false)

      if (serviceExists) {
        console.log('âœ“ ConfigService æ–‡ä»¶å­˜åœ¨')
      } else {
        console.log('âœ— ConfigService æ–‡ä»¶ä¸å­˜åœ¨')
        return false
      }

      // æ£€æŸ¥æ—§æ¨¡å‹æ–‡ä»¶æ˜¯å¦å·²åˆ é™¤
      const oldModels = [
        '../server/src/models/kmlFileStyle.model.js',
        '../server/src/models/panoramaPointStyle.model.js',
        '../server/src/models/videoPointStyle.model.js'
      ]

      for (const model of oldModels) {
        const exists = await fs.access(path.join(__dirname, model)).then(() => true).catch(() => false)
        if (!exists) {
          console.log(`âœ“ æ—§æ¨¡å‹æ–‡ä»¶ ${path.basename(model)} å·²åˆ é™¤`)
        } else {
          console.log(`âš  æ—§æ¨¡å‹æ–‡ä»¶ ${path.basename(model)} ä»ç„¶å­˜åœ¨`)
        }
      }

      console.log('âœ“ ä»£ç å˜æ›´éªŒè¯å®Œæˆ')
      return true
    } catch (error) {
      console.error('âœ— ä»£ç å˜æ›´éªŒè¯å¤±è´¥:', error)
      return false
    }
  }

  async runFullVerification() {
    console.log('å¼€å§‹é‡æ„éªŒè¯...\n')

    const dbResult = await this.verifyDatabase()
    console.log('')
    
    const configResult = await this.verifyConfigFile()
    console.log('')
    
    const codeResult = await this.verifyCodeChanges()
    console.log('')

    if (dbResult && configResult && codeResult) {
      console.log('ğŸ‰ é‡æ„éªŒè¯æˆåŠŸï¼æ‰€æœ‰æ£€æŸ¥é¡¹éƒ½é€šè¿‡ã€‚')
      return true
    } else {
      console.log('âŒ é‡æ„éªŒè¯å¤±è´¥ï¼è¯·æ£€æŸ¥ä¸Šè¿°é—®é¢˜ã€‚')
      return false
    }
  }
}

module.exports = RefactorVerifier

if (require.main === module) {
  const verifier = new RefactorVerifier()
  verifier.runFullVerification().then(success => {
    process.exit(success ? 0 : 1)
  })
}
```
